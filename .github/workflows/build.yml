name: Build Patchworld Bridge

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            name: Windows
            artifact_name: PatchworldBridge.exe
            asset_path: build/PatchworldBridge_artefacts/Release/PatchworldBridge.exe
          - os: macos-latest
            name: macOS
            artifact_name: PatchworldBridge.app
            asset_path: build/PatchworldBridge_artefacts/Release/PatchworldBridge.app
          - os: ubuntu-latest
            name: Linux
            artifact_name: PatchworldBridge
            asset_path: build/PatchworldBridge_artefacts/Release/PatchworldBridge

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3
      with:
        submodules: recursive

    # --- LINUX DEPENDENCIES ---
    - name: Install Linux Deps
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y libasound2-dev libx11-dev libxinerama-dev libxext-dev libfreetype6-dev libwebkit2gtk-4.0-dev libglu1-mesa-dev libjack-jackd2-dev curl

    # --- SETUP RESOURCES ---
    - name: Create Dummy Logo (if missing)
      shell: bash
      run: |
        mkdir -p Source/Resources
        if [ ! -f Source/Resources/logo.png ]; then
          echo "Creating dummy logo"
          touch Source/Resources/logo.png
        fi

    # --- CMAKE CONFIG ---
    - name: Configure CMake
      run: cmake -B build -DCMAKE_BUILD_TYPE=Release

    # --- BUILD ---
    - name: Build
      run: cmake --build build --config Release --parallel 4

    # --- UPLOAD ARTIFACTS ---
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: PatchworldBridge-${{ matrix.name }}
        path: ${{ matrix.asset_path }}